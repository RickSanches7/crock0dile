<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Croc Lab · Месячный трекер привычек</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Чтобы на iPhone выглядело как приложение -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Croc Lab Planner" />
  <meta name="theme-color" content="#ffffff" />

  <!-- Иконка -->
  <link rel="apple-touch-icon" href="crock0dole-icon.png" />
  <link rel="icon" type="image/png" href="crock0dole-icon.png" />

  <style>
    :root {
      /* СВЕТЛАЯ ТЕМА */
      --bg-page: #ffffff;
      --bg-panel: #ffffff;
      --bg-panel-soft: #f5f7ff;
      --grid-border: #d8ddff;

      --text-main: #111322;
      --text-muted: #7a80a2;

      --accent-pink: #ff2e9f;
      --accent-cyan: #27b6ff;
      --accent-purple: #a35bff;
      --accent-green: #12c98a;
      --accent-yellow: #ffc400;
      --danger: #ff4d4d;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "SF Pro Text", "Segoe UI", sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
    }

    /* ---- Заглушка для ПК ---- */
    .desktop-message {
      display: none;
    }

    /* ---- Мобильное "приложение" ---- */
    .app-shell {
      max-width: 480px;
      margin: 0 auto;
      padding: 10px 10px 16px;
      background: var(--bg-page);
    }

    /* Шапка */

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-logo {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #e0e4ff;
      box-shadow: 0 0 12px rgba(39,182,255,0.3);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: inherit;
    }

    .brand-text-title {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 9px;
      color: var(--text-muted);
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .header-caption {
      text-align: right;
      font-size: 10px;
      color: var(--text-muted);
      max-width: 180px;
      line-height: 1.3;
    }

    /* Общие панели */

    .panel {
      background: linear-gradient(145deg, var(--bg-panel-soft), var(--bg-panel));
      border-radius: 14px;
      border: 1px solid var(--grid-border);
      box-shadow: 0 8px 18px rgba(10,10,60,0.10);
      padding: 9px 9px 8px;
      margin-bottom: 10px;
    }

    .panel-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .panel-subtitle {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* Верхний блок: сетка + прогресс */

    .top-main-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 8px;
    }

    .motto-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .motto-title {
      font-size: 14px;
      font-weight: 600;
    }

    .motto-date-box {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .motto-input,
    .date-input,
    .month-input {
      background: #f5f7ff;
      border-radius: 10px;
      border: 1px solid var(--grid-border);
      padding: 4px 8px;
      font-size: 11px;
      color: var(--text-main);
      outline: none;
    }

    .motto-input { width: 100%; }
    .month-input { width: 100%; }

    .motto-input:focus,
    .date-input:focus,
    .month-input:focus {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 1px rgba(39,182,255,0.5);
      background: #ffffff;
    }

    .month-label-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .month-label-row span:first-child {
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    /* Таблица привычек */

    .grid-wrapper {
      border-radius: 12px;
      overflow: auto;
      border: 1px solid var(--grid-border);
      background: #f9faff;
      max-height: 52vh;
    }

    table.main-grid {
      width: 100%;
      min-width: 620px;
      border-collapse: collapse;
      font-size: 9px;
    }

    .main-grid th,
    .main-grid td {
      border: 1px solid var(--grid-border);
      padding: 3px 3px;
      text-align: center;
    }

    .main-grid thead th {
      background: #eef1ff;
      white-space: nowrap;
    }

    .week-band-row th {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    .week-1   { color: var(--accent-pink);   border-bottom: 2px solid var(--accent-pink); }
    .week-2   { color: var(--accent-purple); border-bottom: 2px solid var(--accent-purple); }
    .week-3   { color: var(--accent-cyan);   border-bottom: 2px solid var(--accent-cyan); }
    .week-4   { color: var(--accent-yellow); border-bottom: 2px solid var(--accent-yellow); }
    .week-extra { color: var(--accent-green); border-bottom: 2px solid var(--accent-green); }

    .dow-row th { font-weight: 500; color: var(--text-muted); }
    .daynum-row th { font-weight: 600; color: #333a66; }

    .habit-name-cell {
      text-align: left;
      min-width: 150px;
      background: #eef1ff;
      position: sticky;
      left: 0;
      z-index: 1;
    }

    .habit-input {
      width: 100%;
      border-radius: 6px;
      border: 1px solid var(--grid-border);
      background: #ffffff;
      padding: 3px 5px;
      font-size: 10px;
      color: var(--text-main);
      outline: none;
    }

    .habit-input:focus {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 1px rgba(39,182,255,0.5);
    }

    .day-cell {
      cursor: pointer;
      min-width: 20px;
      height: 18px;
      background: #f9faff;
      transition: background 0.1s ease, box-shadow 0.1s ease, transform 0.05s ease;
    }

    .day-cell:hover {
      background: #e4e7ff;
    }

    .day-cell.done {
      background: radial-gradient(circle at center,
                    var(--accent-green),
                    var(--accent-cyan) 60%);
      box-shadow: 0 0 6px rgba(39,182,255,0.8);
      transform: translateY(-1px);
    }

    /* Боковой прогресс */

    .side-progress {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid var(--grid-border);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .side-title {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .side-main-number {
      font-size: 18px;
      font-weight: 700;
    }

    .side-sub {
      font-size: 10px;
      color: var(--text-muted);
    }

    .mini-bar-row {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 9px;
      margin-bottom: 3px;
    }

    .mini-bar-label {
      width: 26px;
      color: var(--text-muted);
    }

    .mini-bar-track {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: #f3f5ff;
      overflow: hidden;
    }

    .mini-bar-fill {
      width: 0%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg,
        rgba(255,46,159,0.9),
        rgba(39,182,255,0.9),
        rgba(18,201,138,0.9));
      box-shadow: 0 0 6px rgba(39,182,255,0.7);
      transition: width 0.18s ease-out;
    }

    .mini-bar-pct {
      width: 80px;
      text-align: left;
    }

    /* Еженедельный обзор */

    .weekly-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 8px;
    }

    .week-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 9px;
      margin-bottom: 4px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }

    .legend-dot.w1 { background: var(--accent-pink); }
    .legend-dot.w2 { background: var(--accent-purple); }
    .legend-dot.w3 { background: var(--accent-cyan); }
    .legend-dot.w4 { background: var(--accent-yellow); }

    .chart-container {
      width: 100%;
      height: 180px;
    }

    .weekly-summary-list {
      list-style: none;
      margin: 6px 0 0;
      padding: 0;
      font-size: 9px;
      color: var(--text-muted);
    }

    .weekly-summary-list li {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
      border-bottom: 1px dashed #d0d4ff;
    }

    .weekly-summary-list span.value {
      font-weight: 600;
      color: var(--accent-cyan);
    }

    .final-bars {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 6px;
      font-size: 9px;
    }

    .final-bar-item {
      background: #f5f7ff;
      border-radius: 10px;
      border: 1px solid var(--grid-border);
      padding: 4px 4px 5px;
    }

    .final-bar-label {
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    .final-bar-strip {
      height: 8px;
      border-radius: 999px;
      background: #e1e4ff;
      overflow: hidden;
    }

    .final-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg,
        rgba(255,46,159,0.9),
        rgba(39,182,255,0.9));
      box-shadow: 0 0 7px rgba(39,182,255,0.8);
      transition: width 0.2s ease-out;
    }

    .donut-box {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid var(--grid-border);
      padding: 8px;
    }

    .donut-title {
      font-size: 10px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .donut-numbers {
      font-size: 9px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .donut-numbers span {
      display: block;
    }

    /* TOP-3 задачи */

    .top3-hint {
      font-size: 9px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .top3-wrapper {
      border-radius: 12px;
      overflow: auto;
      border: 1px solid var(--grid-border);
      background: #f9faff;
      max-height: 50vh;
    }

    table.top3-grid {
      width: 100%;
      min-width: 620px;
      border-collapse: collapse;
      font-size: 9px;
    }

    .top3-grid th,
    .top3-grid td {
      border: 1px solid var(--grid-border);
      padding: 3px 3px;
    }

    .top3-grid th {
      background: #eef1ff;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    .top3-grid td.day-label {
      width: 70px;
      background: #eef1ff;
      position: sticky;
      left: 0;
      z-index: 1;
      font-weight: 600;
    }

    .top3-task-cell {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .top3-input {
      flex: 1;
      border-radius: 6px;
      border: 1px solid var(--grid-border);
      background: #ffffff;
      padding: 3px 5px;
      font-size: 9px;
      color: var(--text-main);
      outline: none;
    }

    .top3-input:focus {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 1px rgba(39,182,255,0.5);
    }

    .top3-checkbox {
      width: 14px;
      height: 14px;
      accent-color: var(--accent-green);
      cursor: pointer;
    }

    /* Кнопки */

    .controls-row {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 10px;
    }

    button {
      background: #ffffff;
      border-radius: 999px;
      border: 1px solid var(--grid-border);
      color: var(--text-main);
      padding: 4px 10px;
      font-size: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.08s ease, box-shadow 0.15s ease;
    }

    button.neon {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 6px rgba(39,182,255,0.6);
    }

    button.danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    button:hover {
      transform: translateY(-1px);
      background: #f5f7ff;
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
      opacity: 0.9;
    }

    /* Футер */

    .footer {
      margin-top: 6px;
      text-align: center;
      font-size: 9px;
      color: var(--text-muted);
    }

    /* Только мобильная версия: на ПК выдаём сообщение */

    @media (min-width: 769px) {
      .desktop-message {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 24px;
        text-align: center;
        font-size: 16px;
        color: var(--text-main);
        background: #ffffff;
      }
      .desktop-message span { max-width: 480px; }
      .app-shell { display: none; }
    }

    @media (max-width: 768px) {
      .desktop-message { display: none; }
      .app-shell { display: block; }
    }
  </style>
</head>
<body>
  <!-- Сообщение для ПК -->
  <div class="desktop-message">
    <span>
      Croc Lab · месячный трекер привычек.<br /><br />
      Этот планер рассчитан под мобильный экран.
      Открой сайт с телефона, чтобы пользоваться.
    </span>
  </div>

  <!-- Мобильное приложение -->
  <div class="app-shell">
    <header class="header">
      <div class="brand">
        <div class="brand-logo">
          <img src="crock0dole-icon.png" alt="Croc Lab" />
        </div>
        <div>
          <div class="brand-text-title">croc lab</div>
          <div class="brand-text-sub">turn life into a game</div>
        </div>
      </div>
      <div class="header-caption">
        <div>pov: ты превратил жизнь в игру</div>
        <div>месячный трекер привычек</div>
      </div>
    </header>

    <!-- Месячная решётка -->
    <section class="panel">
      <div class="panel-header-row">
        <div class="panel-title">Месячная решётка</div>
        <div class="panel-subtitle">
          Отмечай выполненные привычки, прогресс считается автоматически.
        </div>
      </div>

      <div class="top-main-layout">
        <div>
          <div class="motto-row">
            <div class="motto-title">
              <input id="mottoInput" class="motto-input" type="text" placeholder="Учись постоянно.">
            </div>
            <div class="motto-date-box">
              <span>Дата начала:</span>
              <input id="dateInput" class="date-input" type="date">
            </div>
          </div>

          <div class="month-label-row">
            <span>Месяц</span>
            <input id="monthInput" class="month-input" type="text" placeholder="Например: Декабрь 2025 г.">
          </div>

          <div class="grid-wrapper">
            <table class="main-grid" id="mainGrid">
              <thead>
                <tr class="week-band-row">
                  <th class="habit-name-cell"></th>
                  <th class="week-1" colspan="7">НЕДЕЛЯ 1</th>
                  <th class="week-2" colspan="7">НЕДЕЛЯ 2</th>
                  <th class="week-3" colspan="7">НЕДЕЛЯ 3</th>
                  <th class="week-4" colspan="7">НЕДЕЛЯ 4</th>
                  <th class="week-extra" colspan="3">ДОП.</th>
                </tr>
                <tr class="dow-row">
                  <th class="habit-name-cell">Привычка / задача</th>
                  <th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th><th>Сб</th><th>Вс</th>
                  <th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th><th>Сб</th><th>Вс</th>
                  <th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th><th>Сб</th><th>Вс</th>
                  <th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th><th>Сб</th><th>Вс</th>
                  <th>Пн</th><th>Вт</th><th>Ср</th>
                </tr>
                <tr class="daynum-row">
                  <th class="habit-name-cell"></th>
                  <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>
                  <th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th>
                  <th>15</th><th>16</th><th>17</th><th>18</th><th>19</th><th>20</th><th>21</th>
                  <th>22</th><th>23</th><th>24</th><th>25</th><th>26</th><th>27</th><th>28</th>
                  <th>29</th><th>30</th><th>31</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="controls-row">
            <button id="fillExample" class="neon">Заполнить пример</button>
            <button id="resetChecks" class="danger">Сбросить отметки</button>
            <button id="resetAll" class="danger">Полный сброс</button>
          </div>
        </div>

        <aside class="side-progress">
          <div>
            <div class="side-title">ПРОГРЕСС ЗА МЕСЯЦ</div>
            <div class="side-main-number" id="monthRatio">0 / 0</div>
            <div class="side-sub" id="monthPctText">0% от запланированных привычек</div>
          </div>
          <div id="perHabitBars"></div>
        </aside>
      </div>
    </section>

    <!-- Еженедельный обзор -->
    <section class="panel">
      <div class="panel-header-row">
        <div class="panel-title">Еженедельный обзор</div>
        <div class="panel-subtitle">Прогресс по 4 неделям месяца + распределение задач.</div>
      </div>

      <div class="weekly-layout">
        <div>
          <div class="week-legend">
            <div class="legend-item"><span class="legend-dot w1"></span><span>Неделя 1</span></div>
            <div class="legend-item"><span class="legend-dot w2"></span><span>Неделя 2</span></div>
            <div class="legend-item"><span class="legend-dot w3"></span><span>Неделя 3</span></div>
            <div class="legend-item"><span class="legend-dot w4"></span><span>Неделя 4 + доп.</span></div>
          </div>
          <div class="chart-container">
            <canvas id="weekChart"></canvas>
          </div>
          <ul class="weekly-summary-list" id="weeklyList"></ul>
          <div class="final-bars">
            <div class="final-bar-item">
              <div class="final-bar-label">НЕДЕЛЯ 1</div>
              <div class="final-bar-strip"><div class="final-bar-fill" id="barW1"></div></div>
            </div>
            <div class="final-bar-item">
              <div class="final-bar-label">НЕДЕЛЯ 2</div>
              <div class="final-bar-strip"><div class="final-bar-fill" id="barW2"></div></div>
            </div>
            <div class="final-bar-item">
              <div class="final-bar-label">НЕДЕЛЯ 3</div>
              <div class="final-bar-strip"><div class="final-bar-fill" id="barW3"></div></div>
            </div>
            <div class="final-bar-item">
              <div class="final-bar-label">НЕДЕЛЯ 4</div>
              <div class="final-bar-strip"><div class="final-bar-fill" id="barW4"></div></div>
            </div>
          </div>
        </div>

        <div class="donut-box">
          <div class="donut-title">Задач выполнено</div>
          <div style="width:100%;height:160px;">
            <canvas id="donutChart"></canvas>
          </div>
          <div class="donut-numbers">
            <span id="donutDone">Выполнено: 0</span>
            <span id="donutLeft">Осталось: 0</span>
            <span id="donutPct">Финальный прогресс: 0%</span>
          </div>
        </div>
      </div>
    </section>

    <!-- TOP-3 задачи -->
    <section class="panel">
      <div class="panel-header-row">
        <div class="panel-title">ТОП-3 задачи</div>
        <div class="panel-subtitle">Три ключевых задачи на каждый день месяца.</div>
      </div>
      <div class="top3-hint">
        Пиши конкретные действия. Отмечай галочкой, когда задача выполнена.
      </div>
      <div class="top3-wrapper">
        <table class="top3-grid" id="top3Grid">
          <thead>
            <tr>
              <th>День</th>
              <th>Задача 1</th>
              <th>Задача 2</th>
              <th>Задача 3</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="footer">
      Croc Lab · данные хранятся локально в этом браузере
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    (function () {
      const STORAGE_KEY = "croc_lab_neon_month_v3";
      const HABIT_ROWS = 8;
      const TOTAL_DAYS = 31;
      const WEEKS = 4;
      const DAYS_PER_WEEK = 7;

      const mottoInput = document.getElementById("mottoInput");
      const dateInput = document.getElementById("dateInput");
      const monthInput = document.getElementById("monthInput");
      const mainGridBody = document.querySelector("#mainGrid tbody");
      const perHabitBarsEl = document.getElementById("perHabitBars");
      const monthRatioEl = document.getElementById("monthRatio");
      const monthPctTextEl = document.getElementById("monthPctText");
      const weeklyListEl = document.getElementById("weeklyList");
      const barW1 = document.getElementById("barW1");
      const barW2 = document.getElementById("barW2");
      const barW3 = document.getElementById("barW3");
      const barW4 = document.getElementById("barW4");
      const donutDoneEl = document.getElementById("donutDone");
      const donutLeftEl = document.getElementById("donutLeft");
      const donutPctEl = document.getElementById("donutPct");
      const top3GridBody = document.querySelector("#top3Grid tbody");
      const resetChecksBtn = document.getElementById("resetChecks");
      const resetAllBtn = document.getElementById("resetAll");
      const fillExampleBtn = document.getElementById("fillExample");

      let weekChart = null;
      let donutChart = null;

      function defaultState() {
        const today = new Date();
        const iso = today.toISOString().slice(0, 10);
        const monthLabel = today.toLocaleString("ru-RU", {
          month: "long",
          year: "numeric",
        });

        const habits = Array.from({ length: HABIT_ROWS }, () => ({ text: "" }));
        const checks = Array.from({ length: HABIT_ROWS }, () =>
          Array(TOTAL_DAYS).fill(0)
        );
        const top3Texts = Array.from({ length: TOTAL_DAYS }, () =>
          Array(3).fill("")
        );
        const top3Done = Array.from({ length: TOTAL_DAYS }, () =>
          Array(3).fill(0)
        );

        return {
          motto: "Учись постоянно.",
          monthLabel,
          startDate: iso,
          habits,
          checks,
          top3Texts,
          top3Done,
        };
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return defaultState();
          const parsed = JSON.parse(raw);
          const base = defaultState();

          const habits = base.habits;
          (parsed.habits || []).forEach((h, i) => {
            if (i < habits.length) habits[i].text = h.text || "";
          });

          const checks = base.checks;
          (parsed.checks || []).forEach((row, i) => {
            if (!Array.isArray(row) || i >= HABIT_ROWS) return;
            for (let d = 0; d < Math.min(TOTAL_DAYS, row.length); d++) {
              checks[i][d] = row[d] ? 1 : 0;
            }
          });

          const top3Texts = base.top3Texts;
          const top3Done = base.top3Done;
          (parsed.top3Texts || []).forEach((row, day) => {
            if (!Array.isArray(row) || day >= TOTAL_DAYS) return;
            for (let i = 0; i < Math.min(3, row.length); i++) {
              top3Texts[day][i] = row[i] || "";
            }
          });
          (parsed.top3Done || []).forEach((row, day) => {
            if (!Array.isArray(row) || day >= TOTAL_DAYS) return;
            for (let i = 0; i < Math.min(3, row.length); i++) {
              top3Done[day][i] = row[i] ? 1 : 0;
            }
          });

          return {
            motto: parsed.motto || base.motto,
            monthLabel: parsed.monthLabel || base.monthLabel,
            startDate: parsed.startDate || base.startDate,
            habits,
            checks,
            top3Texts,
            top3Done,
          };
        } catch {
          return defaultState();
        }
      }

      let state = loadState();

      function saveState() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch {}
      }

      /* --- Построение таблиц --- */

      function buildMainGrid() {
        mainGridBody.innerHTML = "";
        for (let row = 0; row < HABIT_ROWS; row++) {
          const tr = document.createElement("tr");

          const nameTd = document.createElement("td");
          nameTd.className = "habit-name-cell";

          const input = document.createElement("input");
          input.type = "text";
          input.className = "habit-input";
          input.placeholder = "Например: Утренняя зарядка";
          input.value = state.habits[row].text || "";
          input.dataset.row = String(row);

          nameTd.appendChild(input);
          tr.appendChild(nameTd);

          for (let d = 0; d < TOTAL_DAYS; d++) {
            const td = document.createElement("td");
            td.className = "day-cell";
            td.dataset.row = String(row);
            td.dataset.day = String(d);
            if (state.checks[row][d]) td.classList.add("done");
            tr.appendChild(td);
          }

          mainGridBody.appendChild(tr);
        }
      }

      function buildPerHabitBars() {
        perHabitBarsEl.innerHTML = "";

        const activeRows = [];
        state.habits.forEach((h, i) => {
          if ((h.text || "").trim()) activeRows.push(i);
        });

        activeRows.forEach((row) => {
          let done = 0;
          for (let d = 0; d < TOTAL_DAYS; d++) {
            if (state.checks[row][d]) done++;
          }
          const pct = TOTAL_DAYS ? Math.round((done / TOTAL_DAYS) * 100) : 0;

          const line = document.createElement("div");
          line.className = "mini-bar-row";

          const label = document.createElement("div");
          label.className = "mini-bar-label";
          label.textContent = pct + "%";

          const track = document.createElement("div");
          track.className = "mini-bar-track";

          const fill = document.createElement("div");
          fill.className = "mini-bar-fill";
          fill.style.width = pct + "%";
          track.appendChild(fill);

          const text = document.createElement("div");
          text.className = "mini-bar-pct";
          text.textContent = state.habits[row].text.slice(0, 16) || "—";

          line.appendChild(label);
          line.appendChild(track);
          line.appendChild(text);
          perHabitBarsEl.appendChild(line);
        });

        if (!activeRows.length) {
          const empty = document.createElement("div");
          empty.className = "side-sub";
          empty.textContent = "Добавь привычки слева, чтобы увидеть детализацию.";
          perHabitBarsEl.appendChild(empty);
        }
      }

      function buildTop3Grid() {
        top3GridBody.innerHTML = "";
        for (let day = 0; day < TOTAL_DAYS; day++) {
          const tr = document.createElement("tr");
          const dayTd = document.createElement("td");
          dayTd.className = "day-label";
          dayTd.textContent = `${day + 1} день`;
          tr.appendChild(dayTd);

          for (let i = 0; i < 3; i++) {
            const td = document.createElement("td");
            const wrap = document.createElement("div");
            wrap.className = "top3-task-cell";

            const input = document.createElement("input");
            input.type = "text";
            input.className = "top3-input";
            input.placeholder = "Задача";
            input.value = state.top3Texts[day][i] || "";
            input.dataset.day = String(day);
            input.dataset.idx = String(i);

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.className = "top3-checkbox";
            checkbox.checked = !!state.top3Done[day][i];
            checkbox.dataset.day = String(day);
            checkbox.dataset.idx = String(i);

            wrap.appendChild(input);
            wrap.appendChild(checkbox);
            td.appendChild(wrap);
            tr.appendChild(td);
          }

          top3GridBody.appendChild(tr);
        }
      }

      /* --- Обработчики --- */

      function attachHandlers() {
        mainGridBody.addEventListener("click", (e) => {
          const td = e.target;
          if (!td.classList.contains("day-cell")) return;
          const row = Number(td.dataset.row);
          const day = Number(td.dataset.day);
          if (Number.isNaN(row) || Number.isNaN(day)) return;

          const cur = state.checks[row][day] ? 1 : 0;
          const next = cur ? 0 : 1;
          state.checks[row][day] = next;
          td.classList.toggle("done", !!next);
          saveState();
          recalcStats();
        });

        mainGridBody.addEventListener("input", (e) => {
          const input = e.target;
          if (!input.classList.contains("habit-input")) return;
          const row = Number(input.dataset.row);
          if (Number.isNaN(row)) return;
          state.habits[row].text = input.value || "";
          saveState();
          recalcStats();
        });

        mottoInput.addEventListener("input", () => {
          state.motto = mottoInput.value || "";
          saveState();
        });

        dateInput.addEventListener("change", () => {
          state.startDate = dateInput.value || "";
          saveState();
        });

        monthInput.addEventListener("input", () => {
          state.monthLabel = monthInput.value || "";
          saveState();
        });

        top3GridBody.addEventListener("input", (e) => {
          const input = e.target;
          if (!input.classList.contains("top3-input")) return;
          const day = Number(input.dataset.day);
          const idx = Number(input.dataset.idx);
          if (Number.isNaN(day) || Number.isNaN(idx)) return;
          state.top3Texts[day][idx] = input.value || "";
          saveState();
        });

        top3GridBody.addEventListener("change", (e) => {
          const el = e.target;
          if (!el.classList.contains("top3-checkbox")) return;
          const day = Number(el.dataset.day);
          const idx = Number(el.dataset.idx);
          if (Number.isNaN(day) || Number.isNaN(idx)) return;
          state.top3Done[day][idx] = el.checked ? 1 : 0;
          saveState();
        });

        resetChecksBtn.addEventListener("click", () => {
          state.checks = state.checks.map((row) => row.map(() => 0));
          saveState();
          buildMainGrid();
          recalcStats();
        });

        resetAllBtn.addEventListener("click", () => {
          if (!confirm("Точно полностью очистить месяц и задачи?")) return;
          state = defaultState();
          saveState();
          initFromState();
        });

        fillExampleBtn.addEventListener("click", () => {
          const examples = [
            "Утренняя зарядка 10 минут",
            "Стакан воды после пробуждения",
            "Чтение 10 минут",
            "Учёба / проект 1 час",
            "Прогулка 20 минут",
            "Глубокая работа без отвлечений",
            "Спорт / тренировка",
            "Дневник / рефлексия перед сном",
          ];
          state.habits.forEach((h, i) => {
            h.text = examples[i] || "";
          });
          state.checks = state.checks.map((row) =>
            row.map(() => (Math.random() < 0.4 ? 1 : 0))
          );
          saveState();
          buildMainGrid();
          recalcStats();
        });
      }

      /* --- Статистика / графики --- */

      function recalcStats() {
        const activeRows = [];
        state.habits.forEach((h, i) => {
          if ((h.text || "").trim()) activeRows.push(i);
        });

        let totalDone = 0;
        let totalPossible = 0;
        const weekStats = Array.from({ length: WEEKS }, () => ({
          done: 0,
          possible: 0,
        }));

        activeRows.forEach((row) => {
          for (let d = 0; d < TOTAL_DAYS; d++) {
            const weekIndex = d >= 28 ? 3 : Math.floor(d / DAYS_PER_WEEK);
            weekStats[weekIndex].possible++;
            totalPossible++;
            if (state.checks[row][d]) {
              weekStats[weekIndex].done++;
              totalDone++;
            }
          }
        });

        const left = Math.max(totalPossible - totalDone, 0);
        const pct = totalPossible
          ? Math.round((totalDone / totalPossible) * 100)
          : 0;

        monthRatioEl.textContent = `${totalDone} / ${totalPossible}`;
        monthPctTextEl.textContent = `${pct}% от запланированных привычек`;
        buildPerHabitBars();

        weeklyListEl.innerHTML = "";
        weekStats.forEach((w, idx) => {
          const li = document.createElement("li");
          const label = document.createElement("span");
          label.textContent = `Неделя ${idx + 1}`;
          const val = document.createElement("span");
          val.className = "value";
          const weekPct = w.possible
            ? Math.round((w.done / w.possible) * 100)
            : 0;
          val.textContent = w.possible
            ? `${w.done} / ${w.possible} · ${weekPct}%`
            : "-";
          li.appendChild(label);
          li.appendChild(val);
          weeklyListEl.appendChild(li);
        });

        const weekPercents = weekStats.map((w) =>
          w.possible ? Math.round((w.done / w.possible) * 100) : 0
        );
        barW1.style.width = weekPercents[0] + "%";
        barW2.style.width = weekPercents[1] + "%";
        barW3.style.width = weekPercents[2] + "%";
        barW4.style.width = weekPercents[3] + "%";

        updateWeekChart(weekPercents);
        updateDonutChart(weekStats, totalDone, left, pct);
      }

      function neonColors(count) {
        const base = [
          "rgba(255,46,159,0.9)",
          "rgba(163,91,255,0.9)",
          "rgba(39,182,255,0.9)",
          "rgba(255,196,0,0.9)",
        ];
        const res = [];
        for (let i = 0; i < count; i++) res.push(base[i % base.length]);
        return res;
      }

      function updateWeekChart(percents) {
        if (typeof Chart === "undefined") return;
        const ctx = document.getElementById("weekChart").getContext("2d");
        const labels = ["Неделя 1", "Неделя 2", "Неделя 3", "Неделя 4"];

        if (!weekChart) {
          weekChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "% выполнено",
                  data: percents,
                  backgroundColor: neonColors(4),
                  borderWidth: 0,
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  labels: {
                    color: "#111322",
                    font: { size: 9 },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: (ctx) => `${ctx.parsed.y}%`,
                  },
                },
              },
              scales: {
                x: {
                  ticks: { color: "#111322", font: { size: 9 } },
                  grid: { display: false },
                },
                y: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    color: "#7a80a2",
                    font: { size: 9 },
                    callback: (v) => v + "%",
                  },
                  grid: { color: "rgba(190,196,240,0.9)" },
                },
              },
            },
          });
        } else {
          weekChart.data.datasets[0].data = percents;
          weekChart.data.datasets[0].backgroundColor = neonColors(4);
          weekChart.update();
        }
      }

      function updateDonutChart(weekStats, totalDone, left, pct) {
        if (typeof Chart === "undefined") return;
        const ctx = document.getElementById("donutChart").getContext("2d");

        const weekDone = weekStats.map((w) => w.done);
        const labels = [
          "Неделя 1",
          "Неделя 2",
          "Неделя 3",
          "Неделя 4",
          "Осталось",
        ];
        const data = [...weekDone, Math.max(left, 0)];

        const colors = [
          "rgba(255,46,159,0.9)",
          "rgba(163,91,255,0.9)",
          "rgba(39,182,255,0.9)",
          "rgba(255,196,0,0.9)",
          "rgba(220,224,255,0.9)",
        ];

        if (!donutChart) {
          donutChart = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels,
              datasets: [
                {
                  data,
                  backgroundColor: colors,
                  borderColor: "#ffffff",
                  borderWidth: 2,
                },
              ],
            },
            options: {
              cutout: "65%",
              plugins: {
                legend: {
                  labels: {
                    color: "#111322",
                    font: { size: 9 },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: (ctx) => `${ctx.label}: ${ctx.parsed}`,
                  },
                },
              },
            },
          });
        } else {
          donutChart.data.labels = labels;
          donutChart.data.datasets[0].data = data;
          donutChart.data.datasets[0].backgroundColor = colors;
          donutChart.update();
        }

        donutDoneEl.textContent = `Выполнено: ${totalDone}`;
        donutLeftEl.textContent = `Осталось: ${left}`;
        donutPctEl.textContent = `Финальный прогресс: ${pct}%`;
      }

      function initFromState() {
        state = loadState();
        mottoInput.value = state.motto || "";
        dateInput.value = state.startDate || "";
        monthInput.value = state.monthLabel || "";
        buildMainGrid();
        buildTop3Grid();
        buildPerHabitBars();
        recalcStats();
      }

      initFromState();
      attachHandlers();
    })();
  </script>
</body>
</html>
