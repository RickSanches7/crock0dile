<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Croc Lab · Месячный трекер привычек</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Иконка Croc Lab (файл crock0dole-icon.png положи в корень репозитория) -->
  <link rel="apple-touch-icon" href="crock0dole-icon.png" />
  <link rel="icon" type="image/png" href="crock0dole-icon.png" />

  <style>
    :root {
      --bg: #02040d;
      --bg-panel: #050919;
      --bg-panel-soft: #070d23;
      --grid-border: #1d2649;
      --text-main: #f7f8ff;
      --text-muted: #94a1d6;

      --accent-pink: #ff2e9f;
      --accent-cyan: #27e4ff;
      --accent-purple: #a95bff;
      --accent-green: #2dff98;
      --accent-yellow: #ffe600;
      --danger: #ff5f5f;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #122259 0, #02040d 55%, #010208 100%);
      color: var(--text-main);
    }

    .app-shell {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 16px 28px;
    }

    /* Шапка */

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 44px;
      height: 44px;
      border-radius: 16px;
      background:
        radial-gradient(circle at 20% 20%, var(--accent-green), transparent 55%),
        radial-gradient(circle at 80% 25%, var(--accent-cyan), transparent 60%),
        radial-gradient(circle at 50% 90%, #041329, #02040d 75%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 16px;
      letter-spacing: 0.08em;
      text-transform: lowercase;
      color: #02040d;
      box-shadow:
        0 0 18px rgba(45, 255, 152, 0.9),
        0 0 26px rgba(39, 228, 255, 0.9);
    }

    .brand-text-title {
      font-size: 19px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .header-caption {
      text-align: right;
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-caption span {
      display: block;
    }

    /* Общие панели */

    .panel {
      background: linear-gradient(145deg, var(--bg-panel-soft), #050919);
      border-radius: 16px;
      border: 1px solid #223368;
      box-shadow:
        0 20px 40px rgba(0, 0, 0, 0.9),
        0 0 26px rgba(39, 228, 255, 0.2);
      padding: 14px 14px 12px;
      margin-bottom: 14px;
    }

    .panel-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 8px;
    }

    .panel-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .panel-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Основной верхний блок: сетка + прогресс */

    .top-main-layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(260px, 1.2fr);
      gap: 12px;
    }

    @media (max-width: 1024px) {
      .top-main-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .motto-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .motto-title {
      font-size: 17px;
      font-weight: 700;
    }

    .motto-date-box {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .motto-input,
    .date-input,
    .month-input {
      background: #04081a;
      border-radius: 999px;
      border: 1px solid #283d7a;
      padding: 4px 10px;
      font-size: 12px;
      color: var(--text-main);
      outline: none;
      min-width: 0;
    }

    .motto-input {
      width: 240px;
      max-width: 60vw;
    }

    .month-input {
      width: 210px;
      max-width: 55vw;
    }

    .motto-input:focus,
    .date-input:focus,
    .month-input:focus {
      border-color: var(--accent-cyan);
      box-shadow:
        0 0 0 1px rgba(39, 228, 255, 0.4),
        0 0 14px rgba(45, 255, 152, 0.5);
    }

    .month-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .month-label-row span:first-child {
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    /* Таблица привычек за месяц */

    .grid-wrapper {
      border-radius: 12px;
      overflow: auto;
      border: 1px solid var(--grid-border);
      background: #050818;
    }

    table.main-grid {
      width: 100%;
      min-width: 1060px;
      border-collapse: collapse;
      font-size: 11px;
    }

    .main-grid th,
    .main-grid td {
      border: 1px solid var(--grid-border);
      padding: 4px 4px;
      text-align: center;
      vertical-align: middle;
    }

    .main-grid thead th {
      background: #070f28;
      white-space: nowrap;
    }

    .week-band-row th {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .week-1 {
      color: var(--accent-pink);
      border-bottom: 2px solid var(--accent-pink);
    }

    .week-2 {
      color: var(--accent-purple);
      border-bottom: 2px solid var(--accent-purple);
    }

    .week-3 {
      color: var(--accent-cyan);
      border-bottom: 2px solid var(--accent-cyan);
    }

    .week-4 {
      color: var(--accent-yellow);
      border-bottom: 2px solid var(--accent-yellow);
    }

    .week-extra {
      color: var(--accent-green);
      border-bottom: 2px solid var(--accent-green);
    }

    .dow-row th {
      font-weight: 500;
      color: var(--text-muted);
    }

    .daynum-row th {
      font-weight: 600;
      color: #e1e4ff;
    }

    .habit-name-cell {
      text-align: left;
      min-width: 210px;
      background: #070f28;
      position: sticky;
      left: 0;
      z-index: 1;
    }

    .habit-input {
      width: 100%;
      border-radius: 7px;
      border: 1px solid #26376a;
      background: #04081a;
      padding: 3px 6px;
      font-size: 12px;
      color: var(--text-main);
      outline: none;
    }

    .habit-input:focus {
      border-color: var(--accent-cyan);
      box-shadow:
        0 0 0 1px rgba(39, 228, 255, 0.35),
        0 0 10px rgba(45, 255, 152, 0.45);
    }

    .day-cell {
      cursor: pointer;
      min-width: 24px;
      height: 22px;
      background: #050818;
      transition:
        background 0.12s ease,
        box-shadow 0.12s ease,
        transform 0.08s ease;
    }

    .day-cell:hover {
      background: #101d3f;
      transform: translateY(-1px);
    }

    .day-cell.done {
      background:
        radial-gradient(circle at center,
          var(--accent-green),
          var(--accent-cyan) 60%);
      box-shadow:
        0 0 10px rgba(45, 255, 152, 0.9),
        0 0 18px rgba(39, 228, 255, 0.9);
    }

    /* Боковая панель прогресса */

    .side-progress {
      background: #050919;
      border-radius: 12px;
      border: 1px solid #223368;
      padding: 10px 10px 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .side-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .side-main-number {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .side-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .mini-bar-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .mini-bar-label {
      width: 32px;
      color: var(--text-muted);
    }

    .mini-bar-track {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: #050818;
      overflow: hidden;
    }

    .mini-bar-fill {
      width: 0%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg,
        rgba(45, 255, 152, 0.9),
        rgba(39, 228, 255, 0.9));
      box-shadow:
        0 0 10px rgba(45, 255, 152, 0.9),
        0 0 16px rgba(39, 228, 255, 0.9);
      transition: width 0.18s ease-out;
    }

    .mini-bar-pct {
      width: 40px;
      text-align: right;
    }

    /* Блок еженедельного обзора */

    .weekly-layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(260px, 1.2fr);
      gap: 12px;
    }

    @media (max-width: 1024px) {
      .weekly-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .week-legend {
      display: flex;
      gap: 8px;
      font-size: 11px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .legend-dot.w1 { background: var(--accent-pink); }
    .legend-dot.w2 { background: var(--accent-purple); }
    .legend-dot.w3 { background: var(--accent-cyan); }
    .legend-dot.w4 { background: var(--accent-yellow); }

    .chart-container {
      width: 100%;
      height: 220px;
    }

    .weekly-summary-list {
      list-style: none;
      margin: 8px 0 0;
      padding: 0;
      font-size: 11px;
      color: var(--text-muted);
    }

    .weekly-summary-list li {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px dashed rgba(60, 90, 140, 0.9);
    }

    .weekly-summary-list span.value {
      font-weight: 600;
      color: var(--accent-cyan);
    }

    .final-bars {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      margin-top: 8px;
      font-size: 10px;
    }

    .final-bar-item {
      background: #050818;
      border-radius: 10px;
      padding: 4px 5px 6px;
      border: 1px solid #23346a;
    }

    .final-bar-label {
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    .final-bar-strip {
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: #02040d;
    }

    .final-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg,
        rgba(255, 46, 159, 0.9),
        rgba(39, 228, 255, 0.9),
        rgba(169, 91, 255, 0.9));
      box-shadow:
        0 0 12px rgba(255, 46, 159, 0.9),
        0 0 18px rgba(39, 228, 255, 0.9);
      transition: width 0.2s ease-out;
    }

    .donut-box {
      background: #050919;
      border-radius: 12px;
      border: 1px solid #23346a;
      padding: 10px 10px 8px;
    }

    .donut-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .donut-numbers {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .donut-numbers span {
      display: block;
    }

    /* Топ-3 задачи на день */

    .top3-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .top3-wrapper {
      border-radius: 12px;
      overflow: auto;
      border: 1px solid var(--grid-border);
      background: #050818;
    }

    table.top3-grid {
      width: 100%;
      min-width: 840px;
      border-collapse: collapse;
      font-size: 11px;
    }

    .top3-grid th,
    .top3-grid td {
      border: 1px solid var(--grid-border);
      padding: 4px 4px;
    }

    .top3-grid th {
      background: #070f28;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    .top3-grid td.day-label {
      width: 80px;
      background: #070f28;
      position: sticky;
      left: 0;
      z-index: 1;
      font-weight: 600;
    }

    .top3-task-cell {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .top3-input {
      flex: 1;
      min-width: 0;
      border-radius: 7px;
      border: 1px solid #26376a;
      background: #04081a;
      padding: 3px 6px;
      font-size: 11px;
      color: var(--text-main);
      outline: none;
    }

    .top3-input:focus {
      border-color: var(--accent-cyan);
      box-shadow:
        0 0 0 1px rgba(39, 228, 255, 0.35),
        0 0 10px rgba(45, 255, 152, 0.45);
    }

    .top3-checkbox {
      width: 14px;
      height: 14px;
      accent-color: var(--accent-green);
      cursor: pointer;
    }

    /* Кнопки */

    .controls-row {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
    }

    button {
      background: #050919;
      border-radius: 999px;
      border: 1px solid #283d7a;
      color: var(--text-main);
      padding: 5px 12px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        transform 0.08s ease,
        box-shadow 0.15s ease;
    }

    button.neon {
      border-color: var(--accent-cyan);
      box-shadow:
        0 0 10px rgba(39, 228, 255, 0.9),
        0 0 18px rgba(45, 255, 152, 0.75);
    }

    button.danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    button:hover {
      transform: translateY(-1px);
      background: #081331;
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
      opacity: 0.9;
    }

    /* Футер */

    .footer {
      margin-top: 12px;
      text-align: center;
      font-size: 10px;
      color: var(--text-muted);
      opacity: 0.7;
    }
    /* ===== АДАПТАЦИЯ ПОД ПЛАНШЕТ / ТЕЛЕФОН ===== */
@media (max-width: 768px) {
  .app-shell {
    padding: 8px 8px 16px;
  }

  .header {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .header-caption {
    text-align: left;
    font-size: 11px;
  }

  .panel {
    padding: 10px 10px 10px;
    border-radius: 12px;
    margin-bottom: 10px;
  }

  .panel-title {
    font-size: 14px;
  }

  .panel-subtitle {
    font-size: 10px;
  }

  .motto-row {
    flex-direction: column;
    align-items: flex-start;
  }

  .motto-input,
  .date-input,
  .month-input {
    width: 100%;
    max-width: 100%;
  }

  /* Вьюшка с таблицей — отдельный скролл, чтобы не растягивать всю страницу */
  .grid-wrapper,
  .top3-wrapper {
    max-height: 60vh;
    overflow-x: auto;
    overflow-y: auto;
  }

  table.main-grid {
    font-size: 9px;
  }

  .habit-name-cell {
    min-width: 160px;
  }

  .day-cell {
    min-width: 24px;
    height: 24px;
  }

  .chart-container {
    height: 200px;
  }

  .weekly-layout,
  .top-main-layout {
    grid-template-columns: minmax(0, 1fr);
  }
}

@media (max-width: 540px) {
  .brand-logo {
    width: 38px;
    height: 38px;
    border-radius: 14px;
    font-size: 14px;
  }

  .brand-text-title {
    font-size: 16px;
  }

  .brand-text-sub {
    font-size: 10px;
  }

  .side-progress {
    padding: 8px;
  }

  .side-main-number {
    font-size: 18px;
  }

  .week-legend {
    font-size: 10px;
  }

  .weekly-summary-list {
    font-size: 10px;
  }

  /* прогресс-блоки по неделям в две колонки, чтобы не были слишком мелкими */
  .final-bars {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  /* топ-3 задачи — тоже отдельный скролл, но крупнее шрифт */
  table.top3-grid {
    min-width: 720px;
    font-size: 10px;
  }

  .top3-input {
    font-size: 10px;
  }
}

  </style>
</head>
<body>
  <div class="app-shell">
    <header class="header">
      <div class="brand">
        <div class="brand-logo">c0</div>
        <div>
          <div class="brand-text-title">croc lab</div>
          <div class="brand-text-sub">turn life into a game</div>
        </div>
      </div>
      <div class="header-caption">
        <span>pov: ты превратил жизнь в игру</span>
        <span>месячный неоновый трекер привычек</span>
      </div>
    </header>

    <!-- Верхний блок: решётка месяца + прогресс -->
    <section class="panel">
      <div class="panel-header-row">
        <div class="panel-title">Месячная решётка привычек</div>
        <div class="panel-subtitle">
          Отмечай выполненные привычки каждый день — графики считаются автоматически
        </div>
      </div>

      <div class="top-main-layout">
        <div>
          <div class="motto-row">
            <div class="motto-title">
              <input id="mottoInput" class="motto-input" type="text"
                     placeholder="Учись постоянно."
              />
            </div>
            <div class="motto-date-box">
              <span>Дата начала:</span>
              <input id="dateInput" class="date-input" type="date" />
            </div>
          </div>

          <div class="month-label-row">
            <span>Месяц</span>
            <input id="monthInput" class="month-input" type="text"
                   placeholder="Например: Декабрь 2025" />
          </div>

          <div class="grid-wrapper">
            <table class="main-grid" id="mainGrid">
              <thead>
                <!-- Полоса недель -->
                <tr class="week-band-row">
                  <th class="habit-name-cell"></th>
                  <th class="week-1" colspan="7">НЕДЕЛЯ 1</th>
                  <th class="week-2" colspan="7">НЕДЕЛЯ 2</th>
                  <th class="week-3" colspan="7">НЕДЕЛЯ 3</th>
                  <th class="week-4" colspan="7">НЕДЕЛЯ 4</th>
                  <th class="week-extra" colspan="3">ДОП.</th>
                </tr>
                <!-- Дни недели -->
                <tr class="dow-row">
                  <th class="habit-name-cell">Привычка / задача</th>
                  <!-- 1–7 -->
                  <th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th><th>Сб</th><th>Вс</th>
                  <!-- 8–14 -->
                  <th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th><th>Сб</th><th>Вс</th>
                  <!-- 15–21 -->
                  <th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th><th>Сб</th><th>Вс</th>
                  <!-- 22–28 -->
                  <th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th><th>Сб</th><th>Вс</th>
                  <!-- 29–31 -->
                  <th>Пн</th><th>Вт</th><th>Ср</th>
                </tr>
                <!-- Номера дней -->
                <tr class="daynum-row">
                  <th class="habit-name-cell"></th>
                  <!-- 1–31 -->
                  <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>
                  <th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th>
                  <th>15</th><th>16</th><th>17</th><th>18</th><th>19</th><th>20</th><th>21</th>
                  <th>22</th><th>23</th><th>24</th><th>25</th><th>26</th><th>27</th><th>28</th>
                  <th>29</th><th>30</th><th>31</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="controls-row">
            <button id="fillExample" class="neon">Заполнить пример</button>
            <button id="resetChecks" class="danger">Сбросить отметки</button>
            <button id="resetAll" class="danger">Полный сброс</button>
          </div>
        </div>

        <!-- Боковая панель прогресса -->
        <aside class="side-progress">
          <div>
            <div class="side-title">ПРОГРЕСС ЗА МЕСЯЦ</div>
            <div class="side-main-number" id="monthRatio">0 / 0</div>
            <div class="side-sub" id="monthPctText">0% от запланированных привычек</div>
          </div>

          <div id="perHabitBars"></div>
        </aside>
      </div>
    </section>

    <!-- Еженедельный обзор -->
    <section class="panel">
      <div class="panel-header-row">
        <div class="panel-title">Еженедельный обзор</div>
        <div class="panel-subtitle">
          Считает прогресс по 4 неделям месяца + общее распределение задач
        </div>
      </div>

      <div class="weekly-layout">
        <div>
          <div class="week-legend">
            <div class="legend-item">
              <span class="legend-dot w1"></span><span>Неделя 1</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot w2"></span><span>Неделя 2</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot w3"></span><span>Неделя 3</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot w4"></span><span>Неделя 4 + доп.</span>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="weekChart"></canvas>
          </div>

          <ul class="weekly-summary-list" id="weeklyList"></ul>

          <div class="final-bars">
            <div class="final-bar-item">
              <div class="final-bar-label">НЕДЕЛЯ 1</div>
              <div class="final-bar-strip">
                <div class="final-bar-fill" id="barW1"></div>
              </div>
            </div>
            <div class="final-bar-item">
              <div class="final-bar-label">НЕДЕЛЯ 2</div>
              <div class="final-bar-strip">
                <div class="final-bar-fill" id="barW2"></div>
              </div>
            </div>
            <div class="final-bar-item">
              <div class="final-bar-label">НЕДЕЛЯ 3</div>
              <div class="final-bar-strip">
                <div class="final-bar-fill" id="barW3"></div>
              </div>
            </div>
            <div class="final-bar-item">
              <div class="final-bar-label">НЕДЕЛЯ 4</div>
              <div class="final-bar-strip">
                <div class="final-bar-fill" id="barW4"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="donut-box">
          <div class="donut-title">Задач выполнено</div>
          <div style="width:100%;height:160px;">
            <canvas id="donutChart"></canvas>
          </div>
          <div class="donut-numbers">
            <span id="donutDone">Выполнено: 0</span>
            <span id="donutLeft">Осталось: 0</span>
            <span id="donutPct">Финальный прогресс: 0%</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Топ-3 задачи на день -->
    <section class="panel">
      <div class="panel-header-row">
        <div class="panel-title">ТОП-3 задачи на каждый день</div>
        <div class="panel-subtitle">
          Для фокуса на главном: до трёх ключевых задач в сутки
        </div>
      </div>

      <div class="top3-hint">
        Пиши конкретные действия. Галочка = задача выполнена. Эти данные тоже
        сохраняются локально.
      </div>

      <div class="top3-wrapper">
        <table class="top3-grid" id="top3Grid">
          <thead>
            <tr>
              <th>День</th>
              <th>Задача 1</th>
              <th>Задача 2</th>
              <th>Задача 3</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="footer">
      Croc Lab · neon monthly planner · данные хранятся в localStorage этого браузера
    </div>
  </div>

  <!-- Chart.js для графиков -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    (function () {
      const STORAGE_KEY = "croc_lab_neon_month_v1";

      const HABIT_ROWS = 8;        // строк привычек
      const TOTAL_DAYS = 31;
      const WEEKS = 4;
      const DAYS_PER_WEEK = 7;

      // DOM-ссылки
      const mottoInput = document.getElementById("mottoInput");
      const dateInput = document.getElementById("dateInput");
      const monthInput = document.getElementById("monthInput");

      const mainGridBody = document.querySelector("#mainGrid tbody");
      const perHabitBarsEl = document.getElementById("perHabitBars");

      const monthRatioEl = document.getElementById("monthRatio");
      const monthPctTextEl = document.getElementById("monthPctText");

      const weeklyListEl = document.getElementById("weeklyList");
      const barW1 = document.getElementById("barW1");
      const barW2 = document.getElementById("barW2");
      const barW3 = document.getElementById("barW3");
      const barW4 = document.getElementById("barW4");

      const donutDoneEl = document.getElementById("donutDone");
      const donutLeftEl = document.getElementById("donutLeft");
      const donutPctEl = document.getElementById("donutPct");

      const top3GridBody = document.querySelector("#top3Grid tbody");

      const resetChecksBtn = document.getElementById("resetChecks");
      const resetAllBtn = document.getElementById("resetAll");
      const fillExampleBtn = document.getElementById("fillExample");

      let weekChart = null;
      let donutChart = null;

      function defaultState() {
        const today = new Date();
        const iso = today.toISOString().slice(0, 10);
        const monthLabel = today.toLocaleString("ru-RU", {
          month: "long",
          year: "numeric",
        });

        const habits = Array.from({ length: HABIT_ROWS }, () => ({
          text: "",
        }));

        const checks = Array.from({ length: HABIT_ROWS }, () =>
          Array(TOTAL_DAYS).fill(0)
        );

        const top3Texts = Array.from({ length: TOTAL_DAYS }, () =>
          Array(3).fill("")
        );
        const top3Done = Array.from({ length: TOTAL_DAYS }, () =>
          Array(3).fill(0)
        );

        return {
          motto: "Учись постоянно.",
          monthLabel,
          startDate: iso,
          habits,
          checks,
          top3Texts,
          top3Done,
        };
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return defaultState();
          const parsed = JSON.parse(raw);
          const base = defaultState();

          const habits = base.habits;
          (parsed.habits || []).forEach((h, i) => {
            if (i < habits.length) habits[i].text = h.text || "";
          });

          const checks = base.checks;
          (parsed.checks || []).forEach((row, i) => {
            if (!Array.isArray(row) || i >= HABIT_ROWS) return;
            for (let d = 0; d < Math.min(TOTAL_DAYS, row.length); d++) {
              checks[i][d] = row[d] ? 1 : 0;
            }
          });

          const top3Texts = base.top3Texts;
          const top3Done = base.top3Done;
          (parsed.top3Texts || []).forEach((row, day) => {
            if (!Array.isArray(row) || day >= TOTAL_DAYS) return;
            for (let i = 0; i < Math.min(3, row.length); i++) {
              top3Texts[day][i] = row[i] || "";
            }
          });
          (parsed.top3Done || []).forEach((row, day) => {
            if (!Array.isArray(row) || day >= TOTAL_DAYS) return;
            for (let i = 0; i < Math.min(3, row.length); i++) {
              top3Done[day][i] = row[i] ? 1 : 0;
            }
          });

          return {
            motto: parsed.motto || base.motto,
            monthLabel: parsed.monthLabel || base.monthLabel,
            startDate: parsed.startDate || base.startDate,
            habits,
            checks,
            top3Texts,
            top3Done,
          };
        } catch {
          return defaultState();
        }
      }

      let state = loadState();

      function saveState() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          console.warn("Failed to save planner state", e);
        }
      }

      /* Рисуем основную сетку */

      function buildMainGrid() {
        mainGridBody.innerHTML = "";
        for (let row = 0; row < HABIT_ROWS; row++) {
          const tr = document.createElement("tr");

          // колонка с названием привычки
          const nameTd = document.createElement("td");
          nameTd.className = "habit-name-cell";

          const input = document.createElement("input");
          input.type = "text";
          input.className = "habit-input";
          input.placeholder = "Например: Утренняя зарядка";
          input.value = state.habits[row].text || "";
          input.dataset.row = String(row);

          nameTd.appendChild(input);
          tr.appendChild(nameTd);

          // 31 день
          for (let d = 0; d < TOTAL_DAYS; d++) {
            const td = document.createElement("td");
            td.className = "day-cell";
            td.dataset.row = String(row);
            td.dataset.day = String(d);

            if (state.checks[row][d]) td.classList.add("done");
            tr.appendChild(td);
          }

          mainGridBody.appendChild(tr);
        }
      }

      function buildPerHabitBars() {
        perHabitBarsEl.innerHTML = "";

        const activeRows = [];
        state.habits.forEach((h, i) => {
          if ((h.text || "").trim()) activeRows.push(i);
        });

        activeRows.forEach((row, idx) => {
          let done = 0;
          for (let d = 0; d < TOTAL_DAYS; d++) {
            if (state.checks[row][d]) done += 1;
          }
          const pct =
            TOTAL_DAYS > 0 ? Math.round((done / TOTAL_DAYS) * 100) : 0;

          const line = document.createElement("div");
          line.className = "mini-bar-row";

          const label = document.createElement("div");
          label.className = "mini-bar-label";
          label.textContent = pct + "%";

          const track = document.createElement("div");
          track.className = "mini-bar-track";

          const fill = document.createElement("div");
          fill.className = "mini-bar-fill";
          fill.style.width = pct + "%";

          track.appendChild(fill);

          const text = document.createElement("div");
          text.className = "mini-bar-pct";
          text.textContent = state.habits[row].text.slice(0, 14) || "—";

          line.appendChild(label);
          line.appendChild(track);
          line.appendChild(text);

          perHabitBarsEl.appendChild(line);
        });

        if (!activeRows.length) {
          const empty = document.createElement("div");
          empty.className = "side-sub";
          empty.textContent = "Добавь привычки слева, чтобы увидеть детализацию.";
          perHabitBarsEl.appendChild(empty);
        }
      }

      /* Топ-3 задачи */

      function buildTop3Grid() {
        top3GridBody.innerHTML = "";
        for (let day = 0; day < TOTAL_DAYS; day++) {
          const tr = document.createElement("tr");

          const dayTd = document.createElement("td");
          dayTd.className = "day-label";
          dayTd.textContent = `${day + 1} день`;
          tr.appendChild(dayTd);

          for (let i = 0; i < 3; i++) {
            const td = document.createElement("td");
            const wrap = document.createElement("div");
            wrap.className = "top3-task-cell";

            const input = document.createElement("input");
            input.type = "text";
            input.className = "top3-input";
            input.placeholder = "Задача";
            input.value = state.top3Texts[day][i] || "";
            input.dataset.day = String(day);
            input.dataset.idx = String(i);

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.className = "top3-checkbox";
            checkbox.checked = !!state.top3Done[day][i];
            checkbox.dataset.day = String(day);
            checkbox.dataset.idx = String(i);

            wrap.appendChild(input);
            wrap.appendChild(checkbox);
            td.appendChild(wrap);
            tr.appendChild(td);
          }

          top3GridBody.appendChild(tr);
        }
      }

      /* События */

      function attachHandlers() {
        // клики по клеткам
        mainGridBody.addEventListener("click", (e) => {
          const td = e.target;
          if (!td.classList.contains("day-cell")) return;
          const row = Number(td.dataset.row);
          const day = Number(td.dataset.day);
          if (Number.isNaN(row) || Number.isNaN(day)) return;

          const cur = state.checks[row][day] ? 1 : 0;
          const next = cur ? 0 : 1;
          state.checks[row][day] = next;
          td.classList.toggle("done", !!next);
          saveState();
          recalcStats();
        });

        // названия привычек
        mainGridBody.addEventListener("input", (e) => {
          const input = e.target;
          if (!input.classList.contains("habit-input")) return;
          const row = Number(input.dataset.row);
          if (Number.isNaN(row)) return;
          state.habits[row].text = input.value || "";
          saveState();
          recalcStats();
        });

        // верхние инпуты
        mottoInput.addEventListener("input", () => {
          state.motto = mottoInput.value || "";
          saveState();
        });

        dateInput.addEventListener("change", () => {
          state.startDate = dateInput.value || "";
          saveState();
        });

        monthInput.addEventListener("input", () => {
          state.monthLabel = monthInput.value || "";
          saveState();
        });

        // топ-3 задачи
        top3GridBody.addEventListener("input", (e) => {
          const input = e.target;
          if (!input.classList.contains("top3-input")) return;
          const day = Number(input.dataset.day);
          const idx = Number(input.dataset.idx);
          if (Number.isNaN(day) || Number.isNaN(idx)) return;
          state.top3Texts[day][idx] = input.value || "";
          saveState();
        });

        top3GridBody.addEventListener("change", (e) => {
          const el = e.target;
          if (!el.classList.contains("top3-checkbox")) return;
          const day = Number(el.dataset.day);
          const idx = Number(el.dataset.idx);
          if (Number.isNaN(day) || Number.isNaN(idx)) return;
          state.top3Done[day][idx] = el.checked ? 1 : 0;
          saveState();
        });

        // кнопки
        resetChecksBtn.addEventListener("click", () => {
          state.checks = state.checks.map((row) => row.map(() => 0));
          saveState();
          buildMainGrid();
          recalcStats();
        });

        resetAllBtn.addEventListener("click", () => {
          if (!confirm("Точно полностью очистить месяц и задачи?")) return;
          state = defaultState();
          saveState();
          initFromState();
        });

        fillExampleBtn.addEventListener("click", () => {
          const examples = [
            "Утренняя зарядка 10 минут",
            "Стакан воды после пробуждения",
            "Чтение 10 минут",
            "Учёба / проект 1 час",
            "Прогулка 20 минут",
            "Глубокая работа без отвлечений",
            "Спорт / тренировка",
            "Дневник / рефлексия перед сном",
          ];
          state.habits.forEach((h, i) => {
            h.text = examples[i] || "";
          });
          state.checks = state.checks.map((row) =>
            row.map(() => (Math.random() < 0.4 ? 1 : 0))
          );
          saveState();
          buildMainGrid();
          recalcStats();
        });
      }

      /* Подсчёты */

      function recalcStats() {
        const activeRows = [];
        state.habits.forEach((h, i) => {
          if ((h.text || "").trim()) activeRows.push(i);
        });

        let totalDone = 0;
        let totalPossible = 0;

        const weekStats = Array.from({ length: WEEKS }, () => ({
          done: 0,
          possible: 0,
        }));

        activeRows.forEach((row) => {
          for (let d = 0; d < TOTAL_DAYS; d++) {
            const isExtra = d >= 28; // 29–31
            const weekIndex = isExtra
              ? 3
              : Math.floor(d / DAYS_PER_WEEK); // 0..3
            weekStats[weekIndex].possible += 1;
            totalPossible += 1;
            if (state.checks[row][d]) {
              weekStats[weekIndex].done += 1;
              totalDone += 1;
            }
          }
        });

        const left = Math.max(totalPossible - totalDone, 0);
        const pct =
          totalPossible > 0
            ? Math.round((totalDone / totalPossible) * 100)
            : 0;

        monthRatioEl.textContent = `${totalDone} / ${totalPossible}`;
        monthPctTextEl.textContent = `${pct}% от запланированных привычек`;
        buildPerHabitBars();

        // список по неделям
        weeklyListEl.innerHTML = "";
        weekStats.forEach((w, idx) => {
          const li = document.createElement("li");
          const label = document.createElement("span");
          label.textContent = `Неделя ${idx + 1}`;
          const val = document.createElement("span");
          val.className = "value";
          const weekPct =
            w.possible > 0
              ? Math.round((w.done / w.possible) * 100)
              : 0;
          val.textContent = w.possible
            ? `${w.done} / ${w.possible} · ${weekPct}%`
            : "-";
          li.appendChild(label);
          li.appendChild(val);
          weeklyListEl.appendChild(li);
        });

        // прогресс-бары по неделям
        const weekPercents = weekStats.map((w) =>
          w.possible ? Math.round((w.done / w.possible) * 100) : 0
        );
        barW1.style.width = weekPercents[0] + "%";
        barW2.style.width = weekPercents[1] + "%";
        barW3.style.width = weekPercents[2] + "%";
        barW4.style.width = weekPercents[3] + "%";

        // график по неделям
          updateWeekChart(weekPercents);

        // пончик «выполнено» — по неделям
          updateDonutChart(weekStats, totalDone, left, pct);

      }

      function neonColors(count) {
        const base = [
          "rgba(255,46,159,0.95)",
          "rgba(169,91,255,0.95)",
          "rgba(39,228,255,0.95)",
          "rgba(255,230,0,0.95)",
        ];
        const res = [];
        for (let i = 0; i < count; i++) res.push(base[i % base.length]);
        return res;
      }

      function updateWeekChart(percents) {
        if (typeof Chart === "undefined") return;
        const ctx = document.getElementById("weekChart").getContext("2d");
        const labels = ["Неделя 1", "Неделя 2", "Неделя 3", "Неделя 4"];

        if (!weekChart) {
          weekChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "% выполнено",
                  data: percents,
                  backgroundColor: neonColors(4),
                  borderWidth: 0,
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  labels: {
                    color: "#f7f8ff",
                    font: { size: 10 },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: (ctx) => `${ctx.parsed.y}%`,
                  },
                },
              },
              scales: {
                x: {
                  ticks: { color: "#f7f8ff", font: { size: 10 } },
                  grid: { display: false },
                },
                y: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    color: "#94a1d6",
                    font: { size: 10 },
                    callback: (v) => v + "%",
                  },
                  grid: { color: "rgba(55, 86, 145, 0.6)" },
                },
              },
            },
          });
        } else {
          weekChart.data.datasets[0].data = percents;
          weekChart.data.datasets[0].backgroundColor = neonColors(4);
          weekChart.update();
        }
      }

      function updateDonutChart(weekStats, totalDone, left, pct) {
  if (typeof Chart === "undefined") return;
  const ctx = document.getElementById("donutChart").getContext("2d");

  // Выполнено по неделям
  const weekDone = weekStats.map((w) => w.done);
  const labels = ["Неделя 1", "Неделя 2", "Неделя 3", "Неделя 4", "Осталось"];
  const data = [...weekDone, Math.max(left, 0)];

  // Те же неоновые цвета, что и в «Еженедельном обзоре»
  const colors = [
    "rgba(255,46,159,0.95)",   // неделя 1
    "rgba(169,91,255,0.95)",   // неделя 2
    "rgba(39,228,255,0.95)",   // неделя 3
    "rgba(255,230,0,0.95)",    // неделя 4 + доп
    "rgba(7,15,40,0.98)",      // осталось (тёмный сегмент)
  ];

  if (!donutChart) {
    donutChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels,
        datasets: [
          {
            data,
            backgroundColor: colors,
            borderColor: "#02040d",
            borderWidth: 2,
          },
        ],
      },
      options: {
        cutout: "65%",
        plugins: {
          legend: {
            labels: {
              color: "#f7f8ff",
              font: { size: 10 },
            },
          },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const label = ctx.label || "";
                const value = ctx.parsed;
                return `${label}: ${value}`;
              },
            },
          },
        },
      },
    });
  } else {
    donutChart.data.labels = labels;
    donutChart.data.datasets[0].data = data;
    donutChart.data.datasets[0].backgroundColor = colors;
    donutChart.update();
  }

  donutDoneEl.textContent = `Выполнено: ${totalDone}`;
  donutLeftEl.textContent = `Осталось: ${left}`;
  donutPctEl.textContent = `Финальный прогресс: ${pct}%`;
}


      /* Инициализация */

      function initFromState() {
        mottoInput.value = state.motto || "";
        dateInput.value = state.startDate || "";
        monthInput.value = state.monthLabel || "";

        buildMainGrid();
        buildTop3Grid();
        buildPerHabitBars();
        recalcStats();
      }

      // запуск
      initFromState();
      attachHandlers();
    })();
  </script>
</body>
</html>
